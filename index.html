<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…¬è»Šå°å¹«æ‰‹ï½œGPS çµ‚æ¥µä¿®æ­£ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDmpPfzwThSFdCYCskziwUpNzffItQPazY&libraries=places"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <style>
    /* ===== å…¨åŸŸè¨­è¨ˆç³»çµ± ===== */
    :root {
      --color-primary: #00b894; 
      --color-primary-dark: #009475;
      --color-secondary: #4a69bd; 
      --color-background: #f4f7f6; 
      --color-surface: #ffffff; 
      --color-text-main: #1b282b; 
      --color-text-soft: #555555; 
      --color-border: #dfe6e9; 
      --color-shadow: rgba(0, 0, 0, 0.08);
      --radius-lg: 16px; 
      --radius-md: 10px; 
      --spacing-md: 12px;
      --spacing-lg: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--color-background);
      color: var(--color-text-main);
      height: 100vh;
      overflow: hidden; 
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      max-width: 420px;
      width: 100%;
      height: 100%;
      background-color: var(--color-surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .app-top-bg {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 145px;
      background: linear-gradient(135deg, #00b894, #00cec9);
      z-index: 0;
    }

    header.app-header {
      padding: 16px var(--spacing-lg) 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--color-surface);
      position: relative;
      z-index: 1;
      flex-shrink: 0; 
    }

    header h1 { font-size: 18px; font-weight: 600; }
    header h1 span { font-size: 13px; font-weight: 400; opacity: 0.8; }
    .header-right { font-size: 12px; text-align: right; line-height: 1.4; }

    /* Main å®¹å™¨è¨­å®š */
    main {
      flex: 1;
      overflow: hidden; 
      padding: 0 var(--spacing-lg);
      position: relative;
      z-index: 1;
      padding-bottom: 10px;
      display: flex;
      flex-direction: column;
    }

    .screen {
      display: none;
      height: 100%; 
      flex-direction: column;
      animation: fadeIn 0.25s ease-out;
    }
    .screen.active { display: flex; }

    /* é¦–é å‡çµçª—æ ¼è¨­å®š */
    .home-static-content {
      flex-shrink: 0; 
      padding-bottom: 10px;
    }
    
    #bus-list {
      flex: 1; 
      overflow-y: auto; 
      padding-right: 2px; 
      scrollbar-width: thin; 
    }
    
    #stops-screen, #reservations-screen, #route-screen, #others-screen, #detail-screen {
        overflow-y: auto;
        padding-bottom: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinning {
        animation: spin 1s linear infinite;
    }

    /* Bottom Nav */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 60px;
      background-color: var(--color-surface);
      border-top: 1px solid var(--color-border);
      box-shadow: 0 -2px 10px var(--color-shadow);
      flex-shrink: 0;
      z-index: 10;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px 0;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 10px;
      color: var(--color-text-soft);
      transition: color 0.2s ease;
    }
    .nav-btn.active { color: var(--color-primary); }
    .nav-icon { font-size: 22px; margin-bottom: 2px; }
    .nav-btn.active .nav-icon { filter: hue-rotate(100deg) saturate(200%); }

    /* Common Components */
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: 0 4px 12px var(--color-shadow);
      margin-bottom: var(--spacing-md);
    }

    .btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-surface);
      box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
    }
    .btn-primary:active { transform: translateY(1px); }
    
    .btn-secondary {
      background-color: var(--color-background);
      color: var(--color-text-main);
      border: 1px solid var(--color-border);
    }
    
    .btn-outline {
      background-color: transparent;
      color: var(--color-secondary);
      border: 1px solid var(--color-secondary);
    }
    .btn-outline:active { background-color: #f0f4ff; }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin: 16px 0 8px;
      color: var(--color-text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hint-text { font-size: 12px; color: var(--color-text-soft); margin-bottom: 10px; }

    /* Home Screen */
    .location-card {
      display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
    }
    .location-main { display: flex; align-items: flex-start; gap: 10px; font-size: 14px; max-width: 60%; }
    .location-tag {
      background-color: #e8f6f3; color: var(--color-primary-dark);
      border-radius: 999px; padding: 2px 10px; font-size: 11px; margin-top: 4px;
      display: inline-flex; align-items: center; gap: 4px;
    }
    .location-right {
      display: flex; flex-direction: column; align-items: flex-end; gap: 6px;
      font-size: 12px; text-align: right; max-width: 40%;
    }
    .location-right-title { font-weight: 600; color: var(--color-primary-dark); display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .location-right-weather { color: var(--color-text-soft); }
    .weather-link { border: none; background: transparent; font-size: 11px; color: var(--color-primary-dark); text-decoration: underline; cursor: pointer; padding: 0; }

    /* Bus List */
    .bus-list-container {
      display: flex; flex-direction: column; background-color: var(--color-surface);
      border-radius: var(--radius-lg); 
    }
    .home-bus-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--color-border);
      background-color: var(--color-surface); cursor: pointer; transition: background-color 0.2s ease;
    }
    .home-bus-row:last-child { border-bottom: none; }
    .home-bus-row:hover { background-color: #f9f9f9; }
    
    .arrival-circle {
      width: 60px; height: 60px; border: 3px solid var(--color-border); border-radius: 50%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 800; color: var(--color-text-main); flex-shrink: 0;
      text-align: center;
      line-height: 1.1;
      background: #fff;
    }
    .arrival-circle.urgent { border-color: #ff6b6b; color: #ff6b6b; }
    .arrival-circle.schedule { border-color: #4a69bd; color: #4a69bd; font-size: 13px; }
    .arrival-circle span { font-size: 10px; font-weight: 400; }
    
    .bus-name { font-size: 16px; font-weight: 700; color: var(--color-text-main); display: flex; align-items: center; gap: 4px; }
    .bus-dest { font-size: 13px; color: var(--color-text-soft); }
    /* è»Šç‰Œè™Ÿç¢¼æ¨£å¼ */
    .bus-plate-badge {
        background: #333; color: #fb1; padding: 1px 5px; border-radius: 4px;
        font-family: monospace; font-size: 11px; font-weight: 700; border: 1px solid #cca000;
        margin-left: 5px;
    }

    /* Detail UI */
    .detail-container {
      display: flex; flex-direction: column; align-items: center;
      padding-top: 10px;
    }
    .detail-route-num {
      font-size: 42px; font-weight: 800; color: #2d3436; margin-bottom: 2px;
      letter-spacing: -1px;
    }
    .detail-current-stop {
        font-size: 15px; font-weight: 700; color: var(--color-primary-dark);
        margin-bottom: 5px; background: #e8f6f3; padding: 4px 12px; border-radius: 99px;
    }
    .detail-direction {
      font-size: 16px; font-weight: 600; color: var(--color-text-soft); margin-bottom: 15px;
    }
    
    .detail-status-big {
      font-size: 36px; font-weight: 800; margin-bottom: 5px; color: var(--color-text-main);
    }
    .detail-status-sub {
      font-size: 14px; color: var(--color-text-soft); margin-bottom: 25px;
    }
    .status-alert { color: #d63031; } 
    .status-ok { color: var(--color-text-main); }
    .status-blue { color: #4a69bd; }

    .info-section {
      width: 100%;
      margin-bottom: 20px;
      text-align: left;
    }
    .info-title {
      font-size: 14px; font-weight: 700; color: var(--color-text-main);
      margin-bottom: 8px; padding-left: 4px;
    }
    .info-card {
      background-color: #f8f9fa;
      border-radius: 12px;
      padding: 12px 16px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .info-row {
      display: flex; align-items: center; gap: 8px; font-size: 14px; color: #4a4a4a;
    }
    
    /* é„°è¿‘ç«™ç‰Œæ¨£å¼ */
    .neighbor-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px;
    }
    .neighbor-row:last-child { border-bottom: none; }
    .neighbor-label { color: #888; width: 60px; flex-shrink: 0; font-weight: 500;}
    .neighbor-name { font-weight: 600; flex: 1; text-align: left; padding: 0 8px; display: flex; align-items: center; gap:4px; }
    .seq-tag { font-size: 10px; background: #eee; color: #666; padding: 1px 4px; border-radius: 4px; }
    .neighbor-time { font-weight: 700; color: var(--color-primary); width: 70px; text-align: right; font-size: 13px;}
    .neighbor-time.grey { color: #ccc; font-weight: 400; }

    .dot {
      width: 10px; height: 10px; border-radius: 50%; display: inline-block;
    }
    .dot.green { background-color: #00b894; }
    .dot.yellow { background-color: #fdcb6e; }
    .dot.red { background-color: #d63031; }

    .detail-actions {
      display: flex; gap: 12px; width: 100%; margin-top: 10px;
    }
    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 99px;
      border: none;
      font-size: 15px; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      cursor: pointer;
    }
    .btn-green { background-color: #e4f9f0; color: #009475; border: 1px solid #00b894; }
    .btn-outline-green { background-color: #fff; color: #009475; border: 1px solid #00b894; }
    .btn-disabled { background-color: #eee; color: #999; border: 1px solid #ddd; cursor: not-allowed; }

    /* Food Screen */
    .food-header-card {
        background-color: #fff8e1;
        border: 1px solid #ffe082;
        color: #f57f17;
        display: flex; align-items: center; gap: 6px; 
        font-weight: 600; font-size: 13px; padding: 10px;
    }
    .food-select {
        flex: 1; border: 1px solid #ffe082; background: #fff;
        padding: 4px 8px; border-radius: 6px; font-size: 13px;
        color: #e67e22; font-weight: 600; cursor: pointer;
    }
    .food-select:focus { outline: none; border-color: #f57f17; }
    
    .scrollable-list {
        max-height: 40vh; overflow-y: auto; 
        border: 1px solid var(--color-border);
        border-radius: 12px; background: #fff;
    }

    .food-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 15px; border-bottom: 1px solid var(--color-border);
    }
    .food-item:last-child { border-bottom: none; }
    .food-img {
      width: 60px; height: 60px; background-color: #eee; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; font-size: 30px;
      background-size: cover; background-position: center; overflow: hidden;
      flex-shrink: 0;
    }
    .food-info h4 { font-size: 15px; margin-bottom: 4px; }
    .food-meta { font-size: 12px; color: var(--color-text-soft); }
    .attribution { font-size: 10px; color: #aaa; margin-top: 5px; }

    /* AI Camera (YOLO-like) */
    #webcam-wrapper {
        position: relative;
        width: 100%;
        max-height: 350px;
        overflow: hidden;
        border-radius: 12px;
        background: #000;
        display: none;
        justify-content: center;
    }
    #webcam-video {
        position: absolute;
        visibility: hidden;
        width: auto;
        height: auto;
    }
    #webcam-canvas {
        width: 100%;
        height: 100%;
        display: block;
    }
    .ai-stat {
        background: #00b894; color: white; padding: 5px 10px; 
        border-radius: 99px; font-size: 14px; font-weight: 700;
        margin-top: 10px; display: inline-block;
    }

    /* Res List */
    .res-group-title {
        font-size: 14px; font-weight: 700; color: var(--color-secondary);
        margin: 15px 0 8px; padding-left: 4px; border-left: 3px solid var(--color-secondary);
        line-height: 1.2;
    }
    .stop-card {
      display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; font-size: 13px;
    }
    .chip-btn {
      border-radius: 999px; border: none; font-size: 11px; padding: 4px 8px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 4px;
    }
    #countdown-text { color: var(--color-primary); font-weight: bold; font-size: 14px; margin-top: 10px; }

  </style>
</head>
<body>
  <div id="map" style="display:none;"></div>

  <div class="app">
    <div class="app-top-bg"></div>
    <header class="app-header">
      <div class="header-left">
        <div class="bus-icon" style="background-color: var(--color-surface); color: var(--color-primary); width: 32px; height: 32px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px;">ğŸšŒ</div>
        <h1 style="display: inline-block; vertical-align: middle;">
          å…¬è»Šå°å¹«æ‰‹<br />
          <span>GPS çœŸå¯¦å‹•æ…‹ç‰ˆ</span>
        </h1>
      </div>
      <div class="header-right">
        <div>ğŸ“ ç›®å‰ä½ç½®</div>
        <div id="header-weather">å¤©æ°£å®šä½ä¸­...</div>
      </div>
    </header>

    <main>
      <section id="welcome-screen" class="screen active">
        <div class="welcome-wrap" style="height: 100%; padding-top: 80px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div class="welcome-emoji" style="width: 90px; height: 90px; border-radius: 32px; margin: 0 auto 10px; background: var(--color-primary); color: var(--color-surface); box-shadow: 0 10px 24px rgba(0, 184, 148, 0.3); display: flex; align-items: center; justify-content: center; font-size: 42px;">ğŸ‘‹</div>
          <div style="margin-top: 20px; font-size: 24px; font-weight: 700;">æ­¡è¿ä½¿ç”¨å…¬è»Šå°å¹«æ‰‹</div>
          <p style="color: var(--color-text-soft); margin-bottom: 20px;">é€£çµ TDX çœŸå¯¦ GPS è³‡æ–™<br>é¡¯ç¤ºè»Šç‰Œï¼Œæ‹’çµ•è™›å‡ï¼</p>
          <div id="countdown-text">3 ç§’å¾Œè‡ªå‹•é€²å…¥...</div>
          <button id="btn-start" class="btn btn-primary" style="margin-top: 20px;">ç«‹å³é–‹å§‹ï¼Œå‰å¾€é¦–é </button>
        </div>
      </section>

      <section id="home-screen" class="screen">
        <div class="home-static-content">
            <div class="card location-card">
              <div class="location-main">
                <span class="icon" style="font-size: 24px;">ğŸ </span>
                <div>
                  <div style="font-weight: 600; margin-bottom: 3px;">æˆ‘çš„å¸¸ç”¨ç«™ç‰Œ</div>
                  <div class="location-tag">GPS + è»Šç‰Œè¾¨è­˜</div>
                </div>
              </div>
              <div class="location-right">
                <div class="location-right-title"><span class="icon">â˜€ï¸</span>å³æ™‚å¤©æ°£</div>
                <div class="location-right-weather">
                  <span id="weather-text">å®šä½ä¸­...</span>
                  <button class="weather-link" id="btn-refresh-weather">æ›´æ–°</button>
                </div>
              </div>
            </div>

            <div class="section-title">
               <span style="font-size: 24px;">ğŸšŒ</span> å³å°‡åˆ°ç«™å…¬è»Š
               <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                   <span id="auto-refresh-timer" style="font-size:12px; font-weight:400; color:#888;">5ç§’å¾Œæ›´æ–°</span>
                   <button id="btn-manual-refresh" style="border:none; background:none; cursor:pointer; font-size:18px; display:flex; align-items:center;" title="ç«‹å³åˆ·æ–°">ğŸ”„</button>
               </div>
            </div>
            <p class="hint-text">è³‡æ–™ä¾†æºï¼šTDX GPS (A1) + é ä¼° (N1)</p>
        </div>

        <div class="bus-list-container" id="bus-list">
          <div style="padding: 20px; text-align: center; color: #888;">æ­£åœ¨é€£ç·š TDX å–å¾—è³‡æ–™...</div>
        </div>
        
        <div style="text-align:center; padding:10px 0; flex-shrink: 0;">
           <button id="btn-to-stops-main" class="btn btn-secondary" style="font-size:12px;">â• æ–°å¢å¸¸ç”¨ç«™ç‰Œ</button>
        </div>
      </section>

      <section id="stops-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">â­</span> å¸¸ç”¨ç«™ç‰Œç®¡ç†</div>
        <p class="hint-text">è¨­å®šæ‚¨å¸¸ç”¨çš„ç«™ç‰Œï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ›æŸ¥çœ‹å³æ™‚è³‡è¨Šã€‚</p>
        <div id="stops-list"></div>
        <button id="btn-add-stop" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">â• æ–°å¢å¸¸ç”¨ç«™ç‰Œ</button>
      </section>

      <section id="reservations-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ“</span> é ç´„ç´€éŒ„</div>
        <p class="hint-text">ç³»çµ±å°‡æœƒåœ¨æ™‚é–“åˆ°æ™‚ç™¼å‡ºé€šçŸ¥ã€‚</p>
        
        <div id="res-list-boarding">
           <div class="res-group-title">ğŸš ä¸Šè»Šæé†’</div>
           <div class="content"></div>
        </div>
        
        <div id="res-list-alighting" style="margin-top: 20px;">
           <div class="res-group-title">ğŸš¶ ä¸‹è»Šæé†’</div>
           <div class="content"></div>
        </div>
        
        <p class="hint-text" style="text-align: center; margin-top: 20px; display: none;" id="no-reservation-text">
          ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„ã€‚
        </p>
      </section>

      <section id="route-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ¦­</span> è¦åŠƒè·¯ç·š</div>
        <p class="hint-text">è¼¸å…¥ç›®çš„åœ°ï¼Œé–‹å•Ÿ Google Maps å°èˆªã€‚</p>
        <section class="route-planner-card card" style="padding: 0; margin-top: 20px;">
          <div class="route-form" style="padding: var(--spacing-md);">
            <div class="route-input-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 60px;">
                <span style="font-size: 18px; color: var(--color-primary); font-weight: 700;">â—</span>
                <span style="width: 2px; height: 20px; background-color: var(--color-border);"></span>
                <span style="font-size: 18px; color: var(--color-secondary);">ğŸ“</span>
              </div>
              <div style="flex-grow: 1;">
                <input type="text" placeholder="æ‚¨çš„ä½ç½® (è‡ªå‹•åµæ¸¬)" readonly style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: 5px; font-size: 14px; background-color: #f9f9f9; color: var(--color-text-soft);"/>
                <input id="destInput" type="text" placeholder="è«‹è¼¸å…¥ç›®çš„åœ° (ä¾‹å¦‚: æ¡ƒåœ’ç«è»Šç«™)" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; background-color: var(--color-surface);"/>
              </div>
            </div>
            <button id="btn-plan-route" type="button" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
              ğŸ—ºï¸ é–‹å•Ÿ Google Maps å°èˆª
            </button>
          </div>
          <div style="padding: 15px; color: #666; font-size: 13px; line-height: 1.5;">
             èªªæ˜ï¼šé»æ“ŠæŒ‰éˆ•å°‡é–‹å•Ÿ Google åœ°åœ– APPï¼Œè‡ªå‹•å¸¶å…¥æ‚¨çš„ç›®å‰ä½ç½®ä½œç‚ºèµ·é»ã€‚
          </div>
        </section>
      </section>

      <section id="others-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ“¸</span> ç«™ç‰Œäººæµ AI åˆ†æ</div>
        <p class="hint-text">åˆ©ç”¨ AI æ”å½±æ©Ÿ (YOLO ç‰©ä»¶åµæ¸¬) è¨ˆç®—å€™è»Šäººæ•¸ã€‚</p>
        
        <div class="card" style="text-align: center; padding-bottom: 10px;">
            <div id="ai-error-msg" style="display:none; color:red; font-size:12px; margin-bottom:10px; background:#fff0f0; padding:5px; border-radius:5px;"></div>
            <button id="btn-start-ai" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">ğŸ“¡ å•Ÿå‹• AI æ”å½±æ©Ÿ</button>
            <button id="btn-stop-ai" class="btn btn-secondary" style="width: 100%; display: none;">ğŸ›‘ é—œé–‰æ”å½±æ©Ÿ</button>
            <button id="btn-demo-ai" class="btn btn-outline" style="width: 100%; margin-top:5px; display: none;">â–¶ï¸ æ¨¡æ“¬æ¼”ç¤º (ç„¡æ³•ä½¿ç”¨ç›¸æ©Ÿæ™‚)</button>
            <div id="webcam-container"></div>
            <div id="label-container"></div>
            
            <div id="webcam-wrapper">
                <video id="webcam-video" playsinline autoplay muted></video>
                <canvas id="webcam-canvas"></canvas>
            </div>
            <div class="ai-stat">ç›®å‰åµæ¸¬äººæ•¸ï¼š<span id="person-count">0</span> äºº</div>
            <div style="font-size: 12px; color: #999; margin-top: 10px;">Powered by TensorFlow.js (COCO-SSD)</div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <div class="section-title"><span style="font-size: 24px;">ğŸ”</span> åˆ°ç«™ç¾é£Ÿæ¨è–¦</div>
        <div class="card food-header-card" id="food-location-container">
           <span>ğŸ“</span>
           <label for="food-stop-select">é™„è¿‘ç«™ç‰Œï¼š</label>
           <select id="food-stop-select" class="food-select">
               <option value="">è«‹é¸æ“‡...</option>
           </select>
        </div>
        <p class="hint-text">é€é Google Maps æœå°‹ç«™ç‰Œé™„è¿‘è©•åƒ¹ä¸éŒ¯çš„ç¾é£Ÿï¼</p>
        <div class="card scrollable-list" id="food-list-container">
            <div style="text-align:center; padding:10px;">è«‹é¸æ“‡ç«™ç‰Œä»¥è¼‰å…¥ç¾é£Ÿ</div>
        </div>
      </section>

      <section id="detail-screen" class="screen">
        <button class="btn btn-secondary" type="button" id="btn-back" style="margin-bottom: 10px; font-size:12px; padding:6px 12px;">â† è¿”å›</button>

        <div class="card" style="padding: 30px 20px 20px; text-align: center;">
          
          <div class="detail-route-num" id="detail-route-num">--</div>
          <div class="detail-direction" id="detail-route-dest">-- â‡„ --</div>
          <div class="detail-current-stop" id="detail-current-stop">æ‰€åœ¨ç«™ç‰Œï¼š--</div>

          <div class="detail-status-big" id="detail-status-big">--</div>
          <div class="detail-status-sub" id="detail-status-sub">--</div>

          <div class="info-section">
            <div class="info-title">å‰å¾Œç«™å‹•æ…‹åƒè€ƒ (ç¢ºèªè»Šè¼›ä½ç½®)</div>
            <div class="info-card">
              <div class="neighbor-row">
                 <div class="neighbor-label">ä¸Šä¸€ç«™</div>
                 <div class="neighbor-name" id="prev-stop-name">--</div>
                 <div class="neighbor-time" id="prev-stop-time">--</div>
              </div>
              <div class="neighbor-row">
                 <div class="neighbor-label">ä¸‹ä¸€ç«™</div>
                 <div class="neighbor-name" id="next-stop-name">--</div>
                 <div class="neighbor-time" id="next-stop-time">--</div>
              </div>
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">è»Šæ³è³‡è¨Š</div>
            <div class="info-card">
              <div class="info-row">
                <span style="font-size:16px;">ğŸšŒ</span>
                <span>è»Šå‹ï¼š<span id="detail-bus-type">ä¸€èˆ¬å…¬è»Š</span></span>
              </div>
              <div class="info-row">
                <span style="font-size:16px;">ğŸ‘¥</span>
                <span>ç‹€æ³ï¼š<span id="detail-crowd-dot" class="dot green"></span> <span id="detail-crowd-text">åº§ä½å……è£• (ç›®å‰è»Šä¸Šç´„ 7 äºº)</span></span>
              </div>
            </div>
          </div>

          <div class="detail-actions">
            <button class="action-btn btn-green" id="btn-reserve-board">ğŸ”” ä¸Šè»Šæé†’</button>
            <button class="action-btn btn-outline-green" id="btn-reserve-alight">ğŸ“ ä¸‹è»Šæé†’</button>
          </div>

        </div>
      </section>
    </main>

    <div id="add-stop-modal" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 20;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px; text-align: center;">
        <div class="modal-title" style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">æ–°å¢å¸¸ç”¨ç«™ç‰Œ</div>
        <div class="modal-row" style="text-align: left; margin-bottom: 15px;">
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">æœå°‹/é¸æ“‡è·¯ç·š</label>
          <input type="text" id="input-route-search" placeholder="è¼¸å…¥è·¯ç·šè™Ÿç¢¼ (ä¾‹å¦‚: 307)" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; margin-bottom: 5px;">
          <select id="select-route-firebase" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px;"><option value="">è¼‰å…¥ä¸­...</option></select>
        </div>
        <div class="modal-row" style="text-align: left; margin-bottom: 20px;">
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">é¸æ“‡ç«™ç‰Œ</label>
          <select id="select-stop-firebase" disabled style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; background-color: #f0f0f0;"><option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option></select>
        </div>
        <div class="modal-actions" style="display: flex; gap: 10px;">
          <button type="button" id="btn-add-stop-cancel" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
          <button type="button" id="btn-add-stop-confirm" class="btn btn-primary" style="flex: 1;">æ–°å¢</button>
        </div>
      </div>
    </div>
    
    <div id="alight-stop-modal" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 25;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px; text-align: center;">
        <div class="modal-title" style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">è«‹é¸æ“‡ä¸‹è»Šç«™ç‰Œ</div>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">ç³»çµ±å°‡åˆ©ç”¨ Google Maps è¨ˆç®—çœŸå¯¦è·¯æ³æ™‚é–“</p>
        <select id="select-alight-stop" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; margin-bottom: 20px;">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <div class="modal-actions" style="display: flex; gap: 10px;">
          <button type="button" id="btn-alight-cancel" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
          <button type="button" id="btn-alight-confirm" class="btn btn-primary" style="flex: 1;">è¨ˆç®—ä¸¦è¨­å®š</button>
        </div>
      </div>
    </div>
    
    <div id="reserve-overlay" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 20;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">é ç´„æˆåŠŸ</div>
        <p id="reserve-msg">å·²åŠ å…¥é ç´„ç´€éŒ„ã€‚</p>
        <button id="btn-modal-ok" class="btn btn-primary" style="width:100%; margin-top:10px;">ç¢ºå®š</button>
      </div>
    </div>
    
    <div id="notification-overlay" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 30;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px; border-left: 5px solid #00b894;">
        <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
           <span>ğŸ””</span> <span id="notif-title">åˆ°ç«™é€šçŸ¥</span>
        </div>
        <div id="notification-content" style="font-size:15px; line-height:1.5; margin-bottom:15px;">å…§å®¹...</div>
        <button id="btn-notification-ok" class="btn btn-primary" style="width:100%;">æ”¶åˆ°</button>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-target="home-screen"><div class="nav-icon">ğŸ </div><div>é¦–é </div></button>
      <button class="nav-btn" data-target="stops-screen"><div class="nav-icon">â­</div><div>å¸¸ç”¨</div></button>
      <button class="nav-btn" data-target="reservations-screen"><div class="nav-icon">ğŸ“</div><div>é ç´„</div></button>
      <button class="nav-btn" data-target="route-screen"><div class="nav-icon">ğŸ§­</div><div>è¦åŠƒ</div></button>
      <button class="nav-btn" data-target="others-screen"><div class="nav-icon">ğŸ”</div><div>å…¶ä»–</div></button>
    </nav>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
    import { getFirestore, collection, getDocs, query } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB1T4agVI78c4vXGLWUBfy5MWo1NwRgEQs",
      authDomain: "busssss-c18d5.firebaseapp.com",
      projectId: "busssss-c18d5",
      storageBucket: "busssss-c18d5.firebasestorage.app",
      messagingSenderId: "1021928933232",
      appId: "1:1021928933232:web:83dd719f9b1112f37031b5"
    };

    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) {
        console.error("Firebase Init Failed:", e);
    }

    const TDX_CLIENT_ID = '314118-8c49cdfe-7af0-424d';     
    const TDX_CLIENT_SECRET = '627ee6d3-a920-47ea-bd5d-7319e03a7f65'; 
    let tdxAccessToken = null;
    let tdxTokenExpiry = 0; 
    let currentRenderId = 0; 
    let refreshTimer = null;
    let countdownTimer = null;
    const REFRESH_RATE_MS = 5000; 

    let allRoutesConfig = []; 
    let STOPS = [];
    let RESERVATIONS = [];
    
    // Init
    initDataFromStorage();
    updateWeather();
    
    // å»¶é²å•Ÿå‹•ï¼Œç¢ºä¿ UI è¼‰å…¥
    setTimeout(() => {
        startAutoRedirect();
    }, 500);

    document.getElementById("btn-manual-refresh").addEventListener("click", async () => {
        const btn = document.getElementById("btn-manual-refresh");
        
        btn.classList.add("spinning");
        btn.disabled = true;

        const busListEl = document.getElementById("bus-list");
        if(busListEl.children.length === 0) {
             busListEl.innerHTML = "<div style='padding:20px;text-align:center;'>æ›´æ–°ä¸­...</div>";
        }

        await renderHomePageBusList();
        
        setTimeout(() => {
            btn.classList.remove("spinning");
            btn.disabled = false;
        }, 500);

        startAutoRefresh();
    });
    
    document.getElementById("input-route-search").addEventListener("input", (e) => {
        const searchText = e.target.value.trim().toUpperCase();
        const select = document.getElementById("select-route-firebase");
        select.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        const filtered = allRoutesConfig.filter(r => r.name.includes(searchText));
        filtered.forEach(route => {
            const opt = document.createElement("option");
            opt.value = route.id;
            opt.textContent = `${route.name} (å¾€ ${route.dest})`; 
            select.appendChild(opt);
        });
    });

    function initDataFromStorage() {
      const savedStops = localStorage.getItem('my_bus_stops');
      if (savedStops) STOPS = JSON.parse(savedStops);
      const savedRes = localStorage.getItem('my_bus_reservations_v2'); 
      if (savedRes) RESERVATIONS = JSON.parse(savedRes);
    }

    function saveDataToStorage() {
      localStorage.setItem('my_bus_stops', JSON.stringify(STOPS));
      localStorage.setItem('my_bus_reservations_v2', JSON.stringify(RESERVATIONS));
    }

    async function fetchRoutesFromFirebase() {
      const busListEl = document.getElementById("bus-list");
      try {
        if(!db) throw new Error("Database not initialized");
        const q = query(collection(db, 'bus_routes'));
        const snapshot = await getDocs(q);
        allRoutesConfig = []; 
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
              const data = doc.data();
              let isAccessible = Math.random() < 0.3; 
              if (data.name && data.name.toString().startsWith('1')) isAccessible = false;
              allRoutesConfig.push({ id: doc.id, isAccessible: isAccessible, ...data });
            });
            allRoutesConfig.sort((a, b) => (a.name || "").localeCompare((b.name || ""), undefined, { numeric: true, sensitivity: 'base' }));
        }
        
        const select = document.getElementById("select-route-firebase");
        if(select.children.length <= 1) {
            allRoutesConfig.forEach(route => {
                const opt = document.createElement("option");
                opt.value = route.id;
                opt.textContent = `${route.name} (å¾€ ${route.dest})`; 
                select.appendChild(opt);
            });
        }
        renderHomePageBusList();  
        renderStopsList();    
      } catch (e) {
        console.error("Firebase Error:", e);
        busListEl.innerHTML = `<div style='padding:20px;text-align:center;color:red;'>é€£ç·šéŒ¯èª¤<br>${e.message}</div>`;
      }
    }

    async function getTDXToken() {
        const now = Date.now();
        if(tdxAccessToken && now < tdxTokenExpiry - 600000) return tdxAccessToken;

        try {
            const formData = new URLSearchParams();
            formData.append('grant_type', 'client_credentials');
            formData.append('client_id', TDX_CLIENT_ID);
            formData.append('client_secret', TDX_CLIENT_SECRET);

            const res = await fetch('https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await res.json();
            tdxAccessToken = data.access_token;
            tdxTokenExpiry = now + (data.expires_in * 1000);
            return data.access_token;
        } catch(e) {
            console.error("TDX Token Error", e);
            return null;
        }
    }

    function processBusTime(busData) {
        if (!busData) return { status: 'unknown' };
        
        // ğŸ”´ åš´æ ¼æª¢æŸ¥ GPS æ™‚é–“æ˜¯å¦å­˜åœ¨ (è§£æ±º 0!=null çš„é™·é˜±)
        if (busData.EstimateTime != null) { 
             return { 
                 status: 'normal', 
                 time: Math.floor(busData.EstimateTime / 60), 
                 plate: busData.PlateNumb || ''
             };
        } else if (busData.NextBusTime) {
             const nextTime = new Date(busData.NextBusTime);
             const hours = nextTime.getHours().toString().padStart(2, '0');
             const mins = nextTime.getMinutes().toString().padStart(2, '0');
             const now = new Date();
             const diffMins = Math.floor((nextTime - now) / 60000);
             
             return { status: 'schedule_calc', time: diffMins > 0 ? diffMins : 0, showTime: `${hours}:${mins}` };
        } else {
             return { status: 'end' };
        }
    }

    async function getBusContext(routeName, stopName, destination) {
        const token = await getTDXToken();
        if(!token) return null; 

        try {
            const url = `https://tdx.transportdata.tw/api/basic/v2/Bus/EstimatedTimeOfArrival/City/Taoyuan/${routeName}?%24format=JSON`;
            
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            // ğŸ”´ 1. å¼·åˆ¶åš´æ ¼æ–¹å‘åˆ¤æ–· (Fix Direction Logic)
            const targetDest = destination.replace(/^å¾€\s*/, '').trim();
            const cleanName = (str) => str.replace(/[()ï¼ˆï¼‰\s]/g, '');

            // å…ˆåˆ†çµ„ Direction
            const dirs = { 0: [], 1: [] };
            data.forEach(d => {
                if(d.Direction === 0 || d.Direction === 1) dirs[d.Direction].push(d);
            });

            // åˆ¤æ–·å“ªä¸€å€‹ Direction çš„ "çµ‚é»ç«™" åŒ…å« ä½¿ç”¨è€…æƒ³è¦çš„ "ç›®çš„åœ°"
            let targetDir = -1;
            
            for (let d in dirs) {
                // æª¢æŸ¥è©²æ–¹å‘æ‰€æœ‰è³‡æ–™ï¼Œæ˜¯å¦æœ‰ä»»ä¸€ç­†çš„ DestinationStopNameZh åŒ…å« targetDest
                const hasMatch = dirs[d].some(item => item.DestinationStopNameZh && item.DestinationStopNameZh.includes(targetDest));
                if (hasMatch) {
                    targetDir = d;
                    break;
                }
            }
            
            // å¦‚æœæ¯”å°å¤±æ•—ï¼Œé è¨­å–æœ‰è³‡æ–™çš„é‚£å€‹æ–¹å‘ (Fall back)
            if (targetDir === -1) {
                 if (dirs[0].length > 0) targetDir = 0;
                 else if (dirs[1].length > 0) targetDir = 1;
            }
            
            let directionData = dirs[targetDir] || [];
            
            // æ’åº (å°åˆ°å¤§)
            directionData.sort((a, b) => a.StopSequence - b.StopSequence);

            // ğŸ”´ 2. æ‰¾å‡ºæ­¤ç«™æ‰€æœ‰è³‡æ–™ (Filter SubRoutes)
            const matches = directionData.filter(d => cleanName(d.StopName.Zh_tw) === cleanName(stopName));
            
            if (matches.length === 0) return { current: { status: 'unknown' }, prev: null, next: null };

            // ğŸ”´ 3. æ’åºå„ªåŒ–ï¼šå„ªå…ˆé¸æœ‰ GPS ä¸”æ™‚é–“çŸ­çš„ (Avoid Ghost Bus)
            matches.sort((a, b) => {
                const timeA = a.EstimateTime;
                const timeB = b.EstimateTime;
                const hasA = (timeA != null);
                const hasB = (timeB != null);

                // æœ‰ GPS å…ˆè´
                if (hasA && !hasB) return -1;
                if (!hasA && hasB) return 1;

                // éƒ½æœ‰ GPSï¼Œé¸æ™‚é–“çŸ­çš„
                if (hasA && hasB) {
                    return timeA - timeB;
                }
                return 0; 
            });

            const current = matches[0]; // æœ€ä½³åŒ¹é…
            const currentPlate = current.PlateNumb;
            const currentSubRoute = current.SubRouteUID;

            // ğŸ”´ 4. å‰å¾Œç«™ã€Œé›™é‡é–å®šã€ï¼šå¿…é ˆåŒ SubRoute + (è‹¥æœ‰è»Šç‰Œ) åŒè»Šç‰Œ
            // éæ¿¾å‡ºåŒä¸€æ¢å­è·¯ç·š
            const subRouteData = directionData.filter(d => d.SubRouteUID === currentSubRoute);
            subRouteData.sort((a, b) => a.StopSequence - b.StopSequence); // ç¢ºä¿é †åºæ­£ç¢º

            let prevData = null;
            let nextData = null;

            if (currentPlate) {
                // GPS æ¨¡å¼ï¼šåš´æ ¼æ¯”å°è»Šç‰Œ (ç¢ºä¿æ˜¯åŒä¸€å°è»Š)
                prevData = subRouteData.find(d => d.StopSequence === current.StopSequence - 1 && d.PlateNumb === currentPlate);
                nextData = subRouteData.find(d => d.StopSequence === current.StopSequence + 1 && d.PlateNumb === currentPlate);
                
                // å¦‚æœæ‰¾ä¸åˆ°ä¸Šä¸€ç«™çš„åŒè»Šç‰Œè³‡æ–™ (ä»£è¡¨è»Šå­å‰›éä¸Šä¸€ç«™)ï¼Œæ‰‹å‹•æ¨™è¨˜ç‚ºã€Œå·²é›¢ç«™ã€
                if (!prevData) {
                     const staticPrev = subRouteData.find(d => d.StopSequence === current.StopSequence - 1);
                     if (staticPrev) {
                         prevData = { ...staticPrev, EstimateTime: -999, PlateNumb: currentPlate }; 
                     }
                }
            } else {
                // Schedule æ¨¡å¼ï¼šä¾é  Sequence
                const idx = subRouteData.findIndex(d => d.StopUID === current.StopUID);
                if (idx > 0) prevData = subRouteData[idx - 1];
                if (idx < subRouteData.length - 1) nextData = subRouteData[idx + 1];
            }

            return {
                current: processBusTime(current),
                prev: prevData ? { name: prevData.StopName.Zh_tw, ...processBusTime(prevData), seq: prevData.StopSequence, plate: prevData.PlateNumb } : null,
                next: nextData ? { name: nextData.StopName.Zh_tw, ...processBusTime(nextData), seq: nextData.StopSequence, plate: nextData.PlateNumb } : null,
                currentSeq: current.StopSequence,
                targetDir: targetDir // å›å‚³æ–¹å‘ID
            };

        } catch(e) {
            console.error("Fetch Error", e);
            return null; 
        }
    }
    
    async function getRealBusArrival(routeName, stopName, destination) {
        const ctx = await getBusContext(routeName, stopName, destination);
        return ctx ? ctx.current : null;
    }

    function startAutoRefresh() {
        stopAutoRefresh(); 
        let timeLeft = REFRESH_RATE_MS / 1000;
        const timerEl = document.getElementById("auto-refresh-timer");
        if (timerEl) timerEl.innerText = `${timeLeft}ç§’å¾Œæ›´æ–°`;

        countdownTimer = setInterval(() => {
            timeLeft--;
            if (timerEl) timerEl.innerText = `${timeLeft}ç§’å¾Œæ›´æ–°`;
            if (timeLeft <= 0) timeLeft = REFRESH_RATE_MS / 1000;
        }, 1000);

        refreshTimer = setInterval(() => {
            const btn = document.getElementById("btn-manual-refresh");
            if(btn) {
                btn.classList.add("spinning");
                setTimeout(() => btn.classList.remove("spinning"), 1000);
            }
            renderHomePageBusList();
        }, REFRESH_RATE_MS);
    }

    function stopAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        if (countdownTimer) clearInterval(countdownTimer);
        const timerEl = document.getElementById("auto-refresh-timer");
        if (timerEl) timerEl.innerText = "æš«åœæ›´æ–°";
    }
    
    async function renderHomePageBusList() {
      currentRenderId++;
      const thisRenderId = currentRenderId;

      initDataFromStorage();
      const busListEl = document.getElementById("bus-list");
      
      if (busListEl.children.length === 0 && !busListEl.innerHTML.includes("æ›´æ–°ä¸­")) {
          busListEl.innerHTML = "<div style='padding:20px;text-align:center;'>æ­£åœ¨å¾ TDX æ›´æ–°å³æ™‚è³‡è¨Š...</div>";
      }
      
      if (STOPS.length === 0) {
        busListEl.innerHTML = `<div style="padding:30px;text-align:center;color:#666;">ç›®å‰é‚„æ²’æœ‰å¸¸ç”¨ç«™ç‰Œ<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</div>`;
        return;
      }

      const promises = STOPS.map(async (stop) => {
          const routeInfo = allRoutesConfig.find(r => r.id === stop.routeId);
          let busName = routeInfo ? routeInfo.name : (stop.routeName || stop.name);
          let dest = stop.direction;
          let isAccessible = routeInfo ? routeInfo.isAccessible : false;

          let arrivalMin = await getRealBusArrival(busName, stop.name, dest);
          
          return { stop, busName, dest, isAccessible, arrivalMin };
      });

      const results = await Promise.all(promises);

      if (thisRenderId !== currentRenderId) return;

      const fragment = document.createDocumentFragment();
      let hasError = false;

      results.forEach(res => {
        let timeHTML = "";
        let circleClass = "arrival-circle";
        let plateHtml = ""; // è»Šç‰Œæ¨™ç±¤
        
        if (res.arrivalMin === null) {
            timeHTML = `<span style="font-size:12px; line-height:1.2;">æ›´æ–°<br>å¤±æ•—</span>`;
            res.arrivalMin = 999; 
            hasError = true;
        } else if (res.arrivalMin.status === 'normal') {
            const min = res.arrivalMin.time;
            const isUrgent = min <= 3;
            circleClass = isUrgent ? "arrival-circle urgent" : "arrival-circle";
            if (min <= 0) timeHTML = `é€²<span>ç«™</span>`;
            else timeHTML = `${min}<span>åˆ†</span>`;
            
            // ğŸ”´ æ–°å¢ï¼šå¦‚æœæœ‰è»Šç‰Œï¼Œé¡¯ç¤ºè»Šç‰Œ
            if(res.arrivalMin.plate) {
                plateHtml = `<span class="bus-plate-badge">${res.arrivalMin.plate}</span>`;
            }
            
        } else if (res.arrivalMin.status === 'schedule_calc') {
            // ğŸ”´ å„ªåŒ–ï¼šå°‡æ™‚åˆ»è¡¨æ™‚é–“è½‰æ›ç‚º GPS é¢¨æ ¼çš„å€’æ•¸
            circleClass = "arrival-circle schedule"; 
            
            if (res.arrivalMin.time <= 60) {
                // 60åˆ†é˜å…§ï¼Œé¡¯ç¤ºå€’æ•¸åˆ†é˜æ•¸ï¼Œä½†æ¨™ç¤ºã€Œè¡¨å®šã€ä»¥å€åˆ†
                const min = res.arrivalMin.time;
                timeHTML = `<span style="font-size:14px; font-weight:700; margin-top:3px;">${min}</span><span style="font-size:9px;">åˆ†(è¡¨å®š)</span>`;
            } else {
                // ä¹…å€™æ¨¡å¼ï¼šè¶…é60åˆ†é˜ï¼Œé¡¯ç¤ºç´…è‰²ä¸¦æ¨™è¨»ã€Œä¸‹ä¸€ç­ã€
                timeHTML = `<span style="font-size:14px; font-weight:700; margin-top:3px; color:#d63031;">${res.arrivalMin.showTime}</span><span style="font-size:9px; color:#d63031; font-weight:bold;">ä¸‹ä¸€ç­</span>`;
            }
            
        } else if (res.arrivalMin.status === 'schedule') {
            circleClass = "arrival-circle schedule";
            timeHTML = `<span style="font-size:13px; font-weight:600;">${res.arrivalMin.time}</span><span>ç™¼è»Š</span>`;
        } else if (res.arrivalMin.status === 'end') {
            timeHTML = `<span style="font-size:11px;">æœ«ç­<br>å·²é</span>`;
        } else {
            timeHTML = `<span style="font-size:11px;">ä»Šæ—¥<br>æœªç™¼</span>`;
        }

        const accessibleHtml = res.isAccessible ? '<span class="icon-accessible" title="ç„¡éšœç¤™å…¬è»Š">â™¿</span>' : '';

        const row = document.createElement("div");
        row.className = "home-bus-row"; 
        row.innerHTML = `
          <div style="display: flex; align-items: center; gap: 15px;">
            <div class="${circleClass}">${timeHTML}</div>
            <div>
              <div class="bus-name">${res.busName} ${accessibleHtml} ${plateHtml}</div>
              <div class="bus-dest">${res.stop.name} (${res.dest})</div>
            </div>
          </div>
          <div style="color: #ccc; font-size: 20px;">â€º</div>
        `;
        
        row.addEventListener("click", () => {
          openDecisionFor({
             routeId: res.stop.routeId, 
             name: res.busName,
             dest: res.dest,
             stopName: res.stop.name,
             busData: res.arrivalMin,
             isAccessible: res.isAccessible
          });
        });
        
        fragment.appendChild(row);
      });

      busListEl.innerHTML = "";
      busListEl.appendChild(fragment);
      
      if (hasError) {
          const hint = document.createElement("div");
          hint.id = "cors-hint";
          hint.style.cssText = "text-align:center; padding:8px; color:#e74c3c; font-size:12px; background:#fff0f0; margin:5px 10px; border-radius:8px;";
          hint.innerHTML = `âš ï¸ æ›´æ–°å¤±æ•— (è«‹æª¢æŸ¥ F12)`;
          const header = document.querySelector(".home-static-content");
          if(header && !header.querySelector("#cors-hint")) header.appendChild(hint);
      } else {
          const oldHint = document.querySelector("#cors-hint");
          if(oldHint) oldHint.remove();
      }
    }


    let pendingBusInfo = null;
    let pendingReservationType = null; 

    // ğŸ”´ é—œéµä¿®æ”¹ï¼šå°‡åŠŸèƒ½ç¶å®šåˆ° windowï¼Œè§£æ±º Module å°è£å°è‡´çš„ã€Œæ‰¾ä¸åˆ°å‡½å¼ã€å•é¡Œ
    
    window.openDecisionFor = async function(busInfo) {
       pendingBusInfo = busInfo; 
       setActiveScreen("detail-screen");

       document.getElementById("detail-route-num").textContent = busInfo.name;
       document.getElementById("detail-route-dest").textContent = busInfo.dest;
       
       // ğŸ”´ æ–°å¢ï¼šé¡¯ç¤ºç•¶å‰ç«™ç‰Œ
       const stopEl = document.getElementById("detail-current-stop");
       if(stopEl) stopEl.textContent = "æ‰€åœ¨ç«™ç‰Œï¼š" + busInfo.stopName;

       // é¡¯ç¤º Loading
       const statusBig = document.getElementById("detail-status-big");
       const statusSub = document.getElementById("detail-status-sub");
       statusBig.textContent = "--"; statusBig.className = "detail-status-big";
       statusSub.textContent = "è³‡æ–™æ›´æ–°ä¸­...";
       
       document.getElementById("prev-stop-name").textContent = "è¼‰å…¥ä¸­...";
       document.getElementById("prev-stop-time").textContent = "--";
       document.getElementById("next-stop-name").textContent = "è¼‰å…¥ä¸­...";
       document.getElementById("next-stop-time").textContent = "--";

       // å–å¾—å®Œæ•´å‰å¾Œç«™è³‡æ–™
       const context = await getBusContext(busInfo.name, busInfo.stopName, busInfo.dest);
       let data = context ? context.current : { status: 'unknown' };
       const prevData = context ? context.prev : null;

       // æ›´æ–°æ¨™é¡Œæ—çš„ç«™åºæç¤º
       if (context && context.currentSeq) {
           stopEl.innerHTML = `æ‰€åœ¨ç«™ç‰Œï¼š${busInfo.stopName} <span style="font-size:12px; color:#888;">(ç¬¬${context.currentSeq}ç«™)</span>`;
       }

       pendingBusInfo.busData = data; 
       
       // æ›´æ–°å¤§æ¨™é¡Œ UI
       if (!data || data.status === 'unknown') {
           statusBig.textContent = "ç„¡æ³•å–å¾—";
           statusSub.textContent = "è«‹ç¢ºèªç¶²è·¯é€£ç·š";
       } else if (data.status === 'normal') {
           const min = data.time;
           if (min <= 0) {
               statusBig.textContent = "é€²ç«™ä¸­";
               statusBig.className = "detail-status-big status-alert"; 
               statusSub.textContent = `è«‹æº–å‚™ä¸Šè»Š (è»Šè™Ÿ: ${data.plate})`;
           } else {
               statusBig.textContent = `${min} åˆ†é˜`;
               statusBig.className = "detail-status-big status-ok";
               statusSub.textContent = `é è¨ˆæŠµé” (è»Šè™Ÿ: ${data.plate})`;
           }
       } else if (data.status === 'schedule_calc') {
           // è¡¨å®šæ™‚é–“æ¨¡å¼
           statusBig.textContent = `${data.showTime} ç™¼è»Š`; 
           statusBig.className = "detail-status-big status-blue";
           statusSub.textContent = `è¡¨å®šæ™‚é–“ (ç´„ ${data.time} åˆ†é˜å¾Œ)`;
           
       } else if (data.status === 'schedule') {
           statusBig.textContent = "å°šæœªç™¼è»Š";
           statusBig.className = "detail-status-big status-blue";
           statusSub.textContent = `é è¨ˆ ${data.time} ç™¼è»Š`;
       } else {
           statusBig.textContent = "æœ«ç­å·²é";
           statusSub.textContent = "ä»Šæ—¥å·²ç„¡ç­æ¬¡";
       }

       // æ›´æ–°å‰å¾Œç«™ï¼Œä¸¦å‚³å…¥ç•¶å‰è»Šç‰Œä»¥ä¾¿éæ¿¾
       updateNeighborUI("prev", context ? context.prev : null, data.plate);
       updateNeighborUI("next", context ? context.next : null, data.plate);

       document.getElementById("detail-bus-type").textContent = busInfo.isAccessible ? "ä½åº•ç›¤å…¬è»Š (ç„¡éšœç¤™)" : "ä¸€èˆ¬å…¬è»Š";
       
       // æ¨¡æ“¬æ“æ“ åº¦ (ä¿ç•™åŸé‚è¼¯)
       const crowdLevels = [
           { text: "åº§ä½å……è£•", color: "green", count: "ç´„ 5~10 äºº" },
           { text: "å°šæœ‰åº§ä½", color: "green", count: "ç´„ 15 äºº" },
           { text: "ç«™ç«‹ç©ºé–“", color: "yellow", count: "ç´„ 30 äºº" },
           { text: "è»Šå»‚æ“æ“ ", color: "red", count: "çˆ†æ»¿" }
       ];
       const crowd = crowdLevels[Math.floor(Math.random() * crowdLevels.length)];
       const dot = document.getElementById("detail-crowd-dot");
       dot.className = `dot ${crowd.color}`;
       document.getElementById("detail-crowd-text").textContent = `${crowd.text}`;

       const onCount = Math.floor(Math.random() * 5) + 1;
       const offCount = Math.floor(Math.random() * 3);
       document.getElementById("detail-on-count").textContent = onCount;
       document.getElementById("detail-off-count").textContent = offCount;
    };

    function updateNeighborUI(prefix, data, currentPlate) {
        const nameEl = document.getElementById(`${prefix}-stop-name`);
        const timeEl = document.getElementById(`${prefix}-stop-time`);
        
        if (!data) {
            // ğŸ”´ ä¿®æ­£ï¼šæ›´å‹å–„çš„æç¤º
            nameEl.textContent = (prefix === 'prev' ? "ğŸš« ç„¡ä¸Šä¸€ç«™ (èµ·é»)" : "ğŸš« ç„¡ä¸‹ä¸€ç«™ (çµ‚é»)");
            timeEl.textContent = "--";
            timeEl.className = "neighbor-time grey";
            return;
        }

        // é¡¯ç¤ºç«™åºï¼Œæ–¹ä¾¿é™¤éŒ¯
        nameEl.innerHTML = `${data.name} <span class="seq-tag">${data.seq}</span>`;
        
        // ğŸ”´ åš´æ ¼éæ¿¾ï¼šå¦‚æœæ™‚é–“æ˜¯ -999ï¼Œä»£è¡¨é€™å°è»Šå·²ç¶“éç«™äº†
        if (data.time === -999) {
             if(prefix === 'prev') {
                 timeEl.textContent = "å·²é›¢ç«™";
                 timeEl.className = "neighbor-time grey";
                 return;
             }
        }
        
        if (data.status === 'normal') {
             const min = data.time;
             timeEl.textContent = min <= 0 ? "é€²ç«™ä¸­" : `${min}åˆ†`;
             timeEl.className = "neighbor-time";
        } else if (data.status === 'schedule_calc') {
             timeEl.textContent = `${data.showTime}`;
             timeEl.className = "neighbor-time grey";
        } else if (data.status === 'schedule') {
             timeEl.textContent = data.time; 
             timeEl.className = "neighbor-time grey";
        } else {
             timeEl.textContent = "æœ«ç­å·²é";
             timeEl.className = "neighbor-time grey";
        }
    }

    window.updateFoodStopSelect = function() {
        const select = document.getElementById("food-stop-select");
        select.innerHTML = '<option value="">è«‹é¸æ“‡ç«™ç‰Œ...</option>';
        if (STOPS.length === 0) {
            select.innerHTML = '<option value="">è«‹å…ˆæ–°å¢å¸¸ç”¨ç«™ç‰Œ</option>';
            return;
        }
        STOPS.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.name;
            opt.innerText = s.name;
            select.appendChild(opt);
        });
        select.onchange = () => { const stopName = select.value; if(stopName) searchFood(stopName); };
    };

    function searchFood(stopName) {
        const container = document.getElementById("food-list-container");
        container.innerHTML = '<div style="padding:20px;text-align:center;">ğŸ” æ­£åœ¨æœå°‹é™„è¿‘ç¾é£Ÿ...</div>';
        
        const request = {
            query: stopName + " é™„è¿‘ç¾é£Ÿ",
            fields: ['name', 'rating', 'formatted_address', 'photos']
        };
        
        try {
            const service = new google.maps.places.PlacesService(document.createElement('div'));
            service.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    container.innerHTML = "";
                    results.slice(0, 10).forEach(place => { // å–å‰10ç­†
                        const photoUrl = place.photos && place.photos.length > 0 
                            ? place.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 }) 
                            : 'https://via.placeholder.com/60?text=Food';
                        const item = document.createElement("div");
                        item.className = "food-item";
                        item.innerHTML = `<div class="food-img" style="background-image: url('${photoUrl}')"></div><div class="food-info"><h4>${place.name}</h4><div class="food-meta">â­ ${place.rating || 'ç„¡'} Â· ${place.formatted_address}</div></div>`;
                        item.addEventListener("click", () => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + " " + place.formatted_address)}`, '_blank'); });
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = `<div style="padding:20px;text-align:center;">æ‰¾ä¸åˆ°çµæœã€‚<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stopName + " ç¾é£Ÿ")}" target="_blank" style="color:#00b894; font-weight:bold;">ğŸ‘‰ é»æ­¤ç›´æ¥é–‹å•Ÿ Google åœ°åœ–æœå°‹</a></div>`;
                }
            });
        } catch(e) {
             container.innerHTML = `<div style="padding:20px;text-align:center;">ç„¡æ³•è¼‰å…¥ APIã€‚<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stopName + " ç¾é£Ÿ")}" target="_blank" style="color:#00b894; font-weight:bold;">ğŸ‘‰ é»æ­¤ç›´æ¥é–‹å•Ÿ Google åœ°åœ–æœå°‹</a></div>`;
        }
    }

    // ... (Remaining Logic Unchanged) ...
    const reserveOverlay = document.getElementById("reserve-overlay");
    const alightStopModal = document.getElementById("alight-stop-modal");
    const notificationOverlay = document.getElementById("notification-overlay");

    document.getElementById("btn-reserve-board").addEventListener("click", () => {
        pendingReservationType = 'boarding';
        document.getElementById("reserve-msg").innerText = "å·²è¨­å®šã€Œä¸Šè»Šæé†’ã€ã€‚\nç•¶å…¬è»Šå³å°‡é€²ç«™æ™‚æœƒé€šçŸ¥æ‚¨ã€‚";
        reserveOverlay.style.display = "flex";
    });

    document.getElementById("btn-reserve-alight").addEventListener("click", () => {
        pendingReservationType = 'alighting';
        
        const route = allRoutesConfig.find(r => r.id === pendingBusInfo.routeId);
        const select = document.getElementById("select-alight-stop");
        select.innerHTML = ""; 

        if (route && route.stops && route.stops.length > 0) {
            let startIndex = route.stops.indexOf(pendingBusInfo.stopName);
            if (startIndex === -1) startIndex = 0; 

            let hasStops = false;
            for (let i = startIndex + 1; i < route.stops.length; i++) {
                const opt = document.createElement("option");
                opt.value = route.stops[i]; 
                opt.textContent = route.stops[i];
                select.appendChild(opt);
                hasStops = true;
            }

            if (!hasStops) {
                const opt = document.createElement("option");
                opt.textContent = "å·²æ˜¯æœ«ç«™ï¼Œç„¡æ³•é ç´„";
                select.appendChild(opt);
                document.getElementById("btn-alight-confirm").disabled = true;
            } else {
                document.getElementById("btn-alight-confirm").disabled = false;
            }
            
            alightStopModal.style.display = "flex";
        } else {
            alert("æ‰¾ä¸åˆ°æ­¤è·¯ç·šçš„ç«™ç‰Œè³‡æ–™ï¼Œç„¡æ³•è¨ˆç®—ç²¾ç¢ºæ™‚é–“ã€‚");
        }
    });

    document.getElementById("btn-alight-confirm").addEventListener("click", async () => {
        const select = document.getElementById("select-alight-stop");
        const stopName = select.value;
        const confirmBtn = document.getElementById("btn-alight-confirm");
        
        confirmBtn.innerText = "æŸ¥è©¢ TDX å³æ™‚è³‡è¨Šä¸­...";
        confirmBtn.disabled = true;

        const arrivalData = await getRealBusArrival(pendingBusInfo.name, stopName, pendingBusInfo.dest);
        
        confirmBtn.innerText = "è¨ˆç®—ä¸¦è¨­å®š";
        confirmBtn.disabled = false;
        
        let estimatedMinutes = 30; // é è¨­å€¼
        if (arrivalData && arrivalData.status === 'normal') {
            estimatedMinutes = arrivalData.time;
        }

        pendingBusInfo.alightStop = stopName;
        pendingBusInfo.travelTime = estimatedMinutes; 

        alightStopModal.style.display = "none";
        document.getElementById("reserve-msg").innerText = `å·²è¨­å®šã€Œä¸‹è»Šæé†’ã€ã€‚\nç›®çš„åœ°ï¼š${stopName}\né è¨ˆé‚„æœ‰ï¼š${estimatedMinutes} åˆ†é˜æŠµé”`;
        reserveOverlay.style.display = "flex";
    });

    document.getElementById("btn-alight-cancel").addEventListener("click", () => {
        alightStopModal.style.display = "none";
    });
    
    document.getElementById("btn-modal-ok").addEventListener("click", () => {
        if(pendingBusInfo && pendingReservationType) {
            const now = new Date();
            const timeStr = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
            
            let targetTime = 0;
            let displayMin = 0;
            let destText = pendingBusInfo.dest;

            let baseArrivalMin = 30; 
            if (pendingBusInfo.busData && pendingBusInfo.busData.status === 'normal') {
                baseArrivalMin = pendingBusInfo.busData.time;
            }
            if(baseArrivalMin <= 0) baseArrivalMin = 0;

            if (pendingReservationType === 'boarding') {
                let arrivalMs = baseArrivalMin * 60 * 1000;
                if (baseArrivalMin <= 0) arrivalMs = 10000;
                targetTime = Date.now() + arrivalMs;
                displayMin = baseArrivalMin;
            } else {
                const minutesUntilAlight = pendingBusInfo.travelTime || 30;
                if (pendingBusInfo.alightStop) destText = pendingBusInfo.alightStop; 

                targetTime = Date.now() + (minutesUntilAlight * 60 * 1000);
                displayMin = minutesUntilAlight;
            }

            RESERVATIONS.push({
               id: Date.now(),
               type: pendingReservationType, 
               time: timeStr,
               bus: pendingBusInfo.name,
               dest: destText,
               arrival: displayMin, 
               targetTime: targetTime,
               notified: false
            });
            saveDataToStorage(); 
            renderReservationsList();
        }
        
        reserveOverlay.style.display = "none";
        document.getElementById("detail-screen").classList.remove("active");
        setActiveScreen("reservations-screen");
        setActiveNav("reservations-screen");
    });

    document.getElementById("btn-notification-ok").addEventListener("click", () => {
        notificationOverlay.style.display = "none";
    });

    function startReservationCheck() {
        setInterval(() => {
            const now = Date.now();
            let hasUpdate = false;
            RESERVATIONS.forEach(res => {
                if (!res.notified && now >= res.targetTime) {
                    showNotification(res);
                    res.notified = true;
                    hasUpdate = true;
                }
            });
            if (hasUpdate) {
                saveDataToStorage();
                renderReservationsList();
            }
        }, 5000);
    }
    
    function showNotification(res) {
        const titleEl = document.getElementById("notif-title");
        const contentEl = document.getElementById("notification-content");
        if (res.type === 'boarding') {
            titleEl.innerText = "å…¬è»Šé€²ç«™é€šçŸ¥";
            contentEl.innerHTML = `<strong>${res.bus}</strong> å³å°‡æŠµé”æ‰€åœ¨ç«™ç‰Œ<br>é–‹å¾€ï¼š${res.dest}<br>è«‹æº–å‚™ä¸Šè»Šï¼`;
        } else {
            titleEl.innerText = "åˆ°ç«™ä¸‹è»Šé€šçŸ¥";
            contentEl.innerHTML = `<strong>${res.bus}</strong> å³å°‡æŠµé”ç›®çš„åœ°<br>ç«™ç‰Œï¼š${res.dest}<br>è«‹æº–å‚™æŒ‰ä¸‹è»Šéˆ´ï¼`;
        }
        notificationOverlay.style.display = "flex";
    }

    function renderReservationsList() {
        const boardEl = document.querySelector("#res-list-boarding .content");
        const alightEl = document.querySelector("#res-list-alighting .content");
        const emptyText = document.getElementById("no-reservation-text");
        
        boardEl.innerHTML = "";
        alightEl.innerHTML = "";
        
        if(RESERVATIONS.length === 0) {
            emptyText.style.display = "block";
            document.getElementById("res-list-boarding").style.display = 'none';
            document.getElementById("res-list-alighting").style.display = 'none';
        } else {
            emptyText.style.display = "none";
            document.getElementById("res-list-boarding").style.display = 'block';
            document.getElementById("res-list-alighting").style.display = 'block';

            RESERVATIONS.forEach(res => {
                const card = document.createElement("div");
                card.className = "card";
                card.style.marginBottom = "10px";
                card.style.padding = "10px";

                const statusText = res.notified ? `<span style="color:#999;">(å·²é€šçŸ¥)</span>` : `<span style="color:#00b894;">â³ ç­‰å¾…ä¸­</span>`;
                const typeText = res.type === 'boarding' ? "ä¸Šè»Š" : "ä¸‹è»Š";
                const typeColor = res.type === 'boarding' ? "#4a69bd" : "#e67e22";

                const minutesLeft = Math.max(0, Math.ceil((res.targetTime - Date.now()) / 60000));
                const timeLeftText = res.notified ? "å·²çµæŸ" : `é‚„æœ‰ç´„ ${minutesLeft} åˆ†é˜`;

                card.innerHTML = `
                   <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                      <span style="font-weight:700; color:${typeColor}; border:1px solid ${typeColor}; padding:1px 4px; border-radius:4px;">${typeText}</span>
                      ${statusText}
                   </div>
                   <div style="font-size:15px; font-weight:700;">${res.bus} <span style="font-weight:400; font-size:12px;">å¾€ ${res.dest}</span></div>
                   <div style="font-size:12px; color:#666; margin-top:4px;">${timeLeftText}</div>
                   <button style="width:100%; border:none; background:#eee; padding:4px; margin-top:8px; border-radius:4px; font-size:12px; color:#666;" onclick="deleteRes(${res.id})">åˆªé™¤</button>
                `;
                
                if (res.type === 'boarding') boardEl.appendChild(card);
                else alightEl.appendChild(card);
            });
            
            if (boardEl.children.length === 0) boardEl.innerHTML = "<div style='font-size:12px; color:#ccc; padding:5px;'>ç„¡ä¸Šè»Šé ç´„</div>";
            if (alightEl.children.length === 0) alightEl.innerHTML = "<div style='font-size:12px; color:#ccc; padding:5px;'>ç„¡ä¸‹è»Šé ç´„</div>";
        }
    }
    
    window.deleteRes = function(id) {
        RESERVATIONS = RESERVATIONS.filter(r => r.id !== id);
        saveDataToStorage();
        renderReservationsList();
    };

    // AI Camera (COCO-SSD)
    let model = null;
    let webcamElement = document.getElementById('webcam-video');
    let canvasElement = document.getElementById('webcam-canvas');
    let aiStream = null;

    window.initAI = async function() {
        try {
            document.getElementById("btn-start-ai").innerText = "â³ è¼‰å…¥ YOLO æ¨¡å‹ä¸­...";
            document.getElementById("btn-start-ai").disabled = true;

            if (!model) {
                model = await cocoSsd.load();
            }

            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { width: { ideal: 640 }, height: { ideal: 480 } }
            });
            
            webcamElement.srcObject = stream;
            aiStream = stream;
            
            webcamElement.onloadeddata = () => {
                webcamElement.play();
                document.getElementById("webcam-wrapper").style.display = "flex";
                document.getElementById("btn-start-ai").style.display = "none";
                document.getElementById("btn-stop-ai").style.display = "inline-block";
                requestAnimationFrame(predictLoop);
            };
        } catch (err) {
            console.error(err);
            alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err.message + "\nè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™æˆ–æ˜¯å¦ç‚º localhost ç’°å¢ƒ");
            document.getElementById("btn-start-ai").innerText = "ğŸ“¡ å•Ÿå‹• AI æ”å½±æ©Ÿ";
            document.getElementById("btn-start-ai").disabled = false;
        }
    };

    async function predictLoop() {
        if (!webcamElement.videoWidth) {
            requestAnimationFrame(predictLoop);
            return;
        }
        
        canvasElement.width = webcamElement.videoWidth;
        canvasElement.height = webcamElement.videoHeight;
        const ctx = canvasElement.getContext('2d');

        const predictions = await model.detect(webcamElement);
        
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.drawImage(webcamElement, 0, 0, ctx.canvas.width, ctx.canvas.height);
        
        let personCount = 0;
        predictions.forEach(prediction => {
            if (prediction.class === 'person') {
                personCount++;
                const [x, y, width, height] = prediction.bbox;
                
                ctx.strokeStyle = '#00FF00'; 
                ctx.lineWidth = 5;            
                ctx.strokeRect(x, y, width, height);
                
                ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                ctx.fillRect(x, y, width, height);

                ctx.fillStyle = '#00FF00';
                ctx.font = 'bold 20px Arial';
                const scoreText = Math.round(prediction.score * 100) + '% person';
                
                const textWidth = ctx.measureText(scoreText).width;
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(x, y > 25 ? y - 25 : 0, textWidth + 10, 25);

                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(scoreText, x + 5, y > 25 ? y - 5 : 20);
            }
        });
        
        document.getElementById("person-count").innerText = personCount;
        requestAnimationFrame(predictLoop);
    }

    window.stopAI = function() {
        if (webcamElement.srcObject) {
            webcamElement.srcObject.getTracks().forEach(track => track.stop());
            webcamElement.srcObject = null;
        }
        document.getElementById("webcam-wrapper").style.display = "none";
        document.getElementById("btn-start-ai").style.display = "inline-block";
        document.getElementById("btn-start-ai").innerText = "ğŸ“¡ å•Ÿå‹• AI æ”å½±æ©Ÿ";
        document.getElementById("btn-start-ai").disabled = false;
        document.getElementById("btn-stop-ai").style.display = "none";
    };

    document.getElementById("btn-start-ai").addEventListener("click", initAI);
    document.getElementById("btn-stop-ai").addEventListener("click", stopAI);

    // Nav Logic
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        setActiveScreen(target);
        setActiveNav(target);
        
        if (target === 'others-screen') {
            if (typeof window.updateFoodStopSelect === 'function') {
                window.updateFoodStopSelect();
            }
        } else {
            if(aiStream) stopAI(); 
        }
        
        if (target === 'home-screen') {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
      });
    });

    function setActiveScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function setActiveNav(id) {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
      if(btn) btn.classList.add("active");
    }

    document.getElementById("btn-plan-route").addEventListener("click", () => {
        const dest = document.getElementById("destInput").value.trim();
        if (!dest) { alert("è«‹è¼¸å…¥ç›®çš„åœ°ï¼"); return; }
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    const lat = p.coords.latitude;
                    const lon = p.coords.longitude;
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${encodeURIComponent(dest)}&travelmode=transit`;
                    window.open(url, '_blank');
                },
                () => {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=transit`;
                    window.open(url, '_blank');
                }
            );
        } else {
            alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        }
    });

    window.goToHome = function() {
      const welcomeScreen = document.getElementById("welcome-screen");
      if (welcomeScreen.classList.contains("active")) {
          setActiveScreen("home-screen");
          setActiveNav("home-screen");
          setTimeout(() => {
              fetchRoutesFromFirebase(); 
              startAutoRefresh(); 
          }, 100);
      }
    };
    
    document.getElementById("btn-start").onclick = window.goToHome;
    
    function startAutoRedirect() {
      let seconds = 3;
      const countdownEl = document.getElementById("countdown-text");
      const interval = setInterval(() => {
        seconds--;
        if(countdownEl) countdownEl.innerText = `${seconds} ç§’å¾Œè‡ªå‹•é€²å…¥...`;
        if (seconds <= 0) { clearInterval(interval); window.goToHome(); }
      }, 1000);
    }
    
    // Add Stop logic remains unchanged
    const addStopModal = document.getElementById("add-stop-modal");
    const selectRouteFirebase = document.getElementById("select-route-firebase");
    const selectStopFirebase = document.getElementById("select-stop-firebase");

    function openAddModal() {
      addStopModal.style.display = "flex";
      selectRouteFirebase.innerHTML = '<option value="">è¼‰å…¥è³‡æ–™ä¸­...</option>';
      selectStopFirebase.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>';
      selectStopFirebase.disabled = true;
      selectStopFirebase.style.backgroundColor = "#f0f0f0";
      if (allRoutesConfig.length === 0) fetchRoutesFromFirebase().then(populateRouteSelect);
      else populateRouteSelect();
    }
    
    document.getElementById("btn-add-stop").addEventListener("click", openAddModal);
    document.getElementById("btn-to-stops-main").addEventListener("click", openAddModal);

    function populateRouteSelect() {
      selectRouteFirebase.innerHTML = '<option value="">è«‹é¸æ“‡è·¯ç·š...</option>';
      allRoutesConfig.forEach(route => {
        const opt = document.createElement("option");
        opt.value = route.id;
        opt.textContent = `${route.name} (å¾€ ${route.dest})`; 
        selectRouteFirebase.appendChild(opt);
      });
    }

    selectRouteFirebase.addEventListener("change", () => {
        const routeId = selectRouteFirebase.value;
        if (!routeId) {
          selectStopFirebase.disabled = true; return;
        }
        const route = allRoutesConfig.find(r => r.id === routeId);
        selectStopFirebase.innerHTML = '<option value="">è«‹é¸æ“‡ç«™ç‰Œ...</option>';
        if (route && route.stops) {
          route.stops.forEach(stopName => {
            const opt = document.createElement("option");
            opt.value = stopName; opt.textContent = stopName;
            selectStopFirebase.appendChild(opt);
          });
          selectStopFirebase.disabled = false; selectStopFirebase.style.backgroundColor = "#fff";
        }
    });

    document.getElementById("btn-add-stop-cancel").addEventListener("click", () => addStopModal.style.display = "none");
    document.getElementById("btn-add-stop-confirm").addEventListener("click", () => {
      const routeId = selectRouteFirebase.value;
      const stopName = selectStopFirebase.value;
      if (!routeId || !stopName) { alert("è«‹å®Œæ•´é¸æ“‡"); return; }
      const route = allRoutesConfig.find(r => r.id === routeId);
      STOPS.push({
        id: Date.now(),
        routeId: routeId, routeName: route.name, name: stopName,
        direction: `å¾€ ${route.dest}`, isDefault: false
      });
      saveDataToStorage();
      renderStopsList(); renderHomePageBusList(); 
      addStopModal.style.display = "none";
      setActiveScreen("home-screen"); setActiveNav("home-screen");
    });

    function renderStopsList() {
      const stopsListEl = document.getElementById("stops-list");
      stopsListEl.innerHTML = "";
      if (STOPS.length === 0) {
        stopsListEl.innerHTML = `<div style="font-size:12px;color:#000;">ç›®å‰é‚„æ²’æœ‰å¸¸ç”¨ç«™ç‰Œã€‚</div>`; return;
      }
      STOPS.forEach(stop => {
        let routeName = stop.routeName;
        let isAccessible = false;
        if (allRoutesConfig.length > 0) {
           const r = allRoutesConfig.find(x => x.id === stop.routeId);
           if(r) { routeName = r.name; isAccessible = r.isAccessible; }
        }
        const badgeHtml = routeName ? `<span style="background:var(--color-primary); color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:6px; font-weight:700;">${routeName}</span>` : '';
        const accessibleHtml = isAccessible ? '<span class="icon-accessible">â™¿</span>' : '';
        const card = document.createElement("div");
        card.className = "stop-card card";
        card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:600; font-size:15px; display:flex; align-items:center;">${badgeHtml} ${stop.name} ${accessibleHtml}</div><button class="chip-btn" style="background:#ffe6e6;color:red;" onclick="removeStop(${stop.id})">åˆªé™¤</button></div><div style="font-size:12px; color:#666; margin-top:4px; padding-left: 2px;">${stop.direction}</div>`;
        stopsListEl.appendChild(card);
      });
    }

    window.removeStop = function(id) {
       if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
       STOPS = STOPS.filter(s => s.id !== id);
       saveDataToStorage();
       renderStopsList(); renderHomePageBusList();
    };
    
    document.getElementById("btn-back").addEventListener("click", () => {
       setActiveScreen("home-screen"); setActiveNav("home-screen");
       startAutoRefresh(); 
    });
    
    function updateWeather() {
        const headerWeatherEl = document.getElementById("header-weather");
        const homeWeatherEl = document.getElementById("weather-text");
        if(homeWeatherEl) homeWeatherEl.innerText = "å®šä½ä¸­...";
        if(headerWeatherEl) headerWeatherEl.innerText = "å®šä½ä¸­...";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude; const lon = position.coords.longitude;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
                    fetch(url).then(res => res.json()).then(data => {
                        const w = data.current_weather; const text = `${w.temperature}Â°C`;
                        if(homeWeatherEl) homeWeatherEl.innerText = `${text}ãƒ»ç›®å‰ä½ç½®`;
                        if(headerWeatherEl) headerWeatherEl.innerText = text;
                    }).catch(e => console.error(e));
                },
                (err) => {
                    const msg = "å®šä½æ¬Šé™å—æ‹’";
                    if(homeWeatherEl) homeWeatherEl.innerText = msg;
                    if(headerWeatherEl) headerWeatherEl.innerText = msg;
                }
            );
        } else { if(homeWeatherEl) homeWeatherEl.innerText = "ä¸æ”¯æ´å®šä½"; }
    }
    document.getElementById("btn-refresh-weather").addEventListener("click", updateWeather);

    // Boot
    startAutoRedirect();
    startReservationCheck();
    renderReservationsList(); 
  </script>
</body>
</html>